generator client {
  provider    = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider  = "mongodb"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATEBASE_URL")
}

model Account {
  id                 String  @id @default(auto()) @map("_id") @db.ObjectId
  userId             String  @map("user_id") @db.ObjectId
  type               String
  provider           String
  providerAccountId  String  @map("provider_account_id")
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?
 
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
 
  @@unique([provider, providerAccountId])
  @@map("accounts")
}
 
model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id") @db.ObjectId
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
 
  @@map("sessions")
}

enum Role {
  user
  admin
}
 
model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  name          String?
  email         String   @unique
  emailVerified DateTime? @map("email_verified")
  passwordResetTokens PasswordResetToken[]
  emailVerificationTokens EmailVerificationToken[]
  password      String? @map("password")
  image         String?
  role          Role @default(user) 

  accounts      Account[]
  sessions      Session[]
  rating        Rating[]
  order         Order[]
  likes         Like[]
  cart          Cart?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now())
 
  @@map("users")
}

model PasswordResetToken {
  id        String   @id @default(cuid()) @map("_id")
  token     String   @unique           // SHA-256 hashed token
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@map("passwordResetTokens")
}

model EmailVerificationToken {
  id        String   @id @default(cuid())@map("_id")
  otp       String                          // SHA-256 hashed OTP
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@map("emailVerificationTokens")
}
 
model VerificationToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String
  token      String
  expires    DateTime
 
  @@unique([identifier, token])
  @@map("verificationtokens")
}

model Tag {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  slug        String  @unique
  categoryId  String @map("category_id") @db.ObjectId
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  productIDs  String[] @map("product_ids") @db.ObjectId
  products    Product[] @relation(fields: [productIDs], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())

  @@map("tags")
  @@index([categoryId])
}

model Category {
    id        String @id @default(auto()) @map("_id") @db.ObjectId
    name      String
    slug      String @unique
    tags      Tag[]
    products  Product[]
    createdAt DateTime @default(now())
    updatedAt DateTime @default(now())

    @@map("categories")
}

model Rating {
  id            String @id @default(auto()) @map("_id") @db.ObjectId
  rating        Int
  comment       String?

  postedBy      User @relation(fields: [postedById], references: [id]) 
  postedById    String @db.ObjectId

  productId     String @map("product_id") @db.ObjectId
  product       Product @relation(fields: [productId], references: [id])
  
  @@map("ratings")
  @@unique([postedById, productId])
  @@index([postedById])
  @@index([productId])
}

model Product {
    id              String @id @default(auto()) @map("_id") @db.ObjectId
    title           String @unique
    slug            String @unique
    description     String 
    price           Int
    previousPrice   Int?
    color           String[]
    brand           String
    shipping        Int?
    stock           Int?

    images          Image[]
    ratings         Rating[]
    cartItems       CartItem[]
    likes           Like[]
    categoryId      String @map("category_id") @db.ObjectId
    category        Category @relation(fields: [categoryId], references: [id])
    tagIds          String[] @map("tag_ids") @db.ObjectId
    tags            Tag[] @relation(fields: [tagIds], references: [id])
    createdAt       DateTime @default(now())
    updatedAt       DateTime @default(now())

  @@map("products")
  @@index([categoryId])
  @@index([createdAt])
  @@index([brand])
  @@index([categoryId, brand])
}

model Like {
  id        String @id @default(auto()) @map("_id") @db.ObjectId

  userId    String @db.ObjectId
  user      User   @relation(fields: [userId], references: [id])

  productId String @db.ObjectId
  product   Product @relation(fields: [productId], references: [id])

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
}

type Image {
  public_id    String 
  secure_url   String 

}

enum OrderStatus {
  pending
  paid
  failed
  cancelled
  refunded
}

model Order {
  id                String @id @default(auto()) @map("_id") @db.ObjectId

  userId            String @map("user_id") @db.ObjectId
  user              User @relation(fields: [userId], references: [id])

  items             OrderItem[]

  chargeId          String
  payment_intent    String
  receipt_url       String 
  refunded          Boolean
  status            OrderStatus
  amount_captured   Int 
  currency          String

  shipping          Shipping
  refundId          String?
  deliveryStatus    DeliveryStatus @default(NotProcessed)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now())

  @@map("orders")
  @@index([userId])
  @@index([createdAt])

}

model OrderItem {
  id        String @id @default(auto()) @map("_id") @db.ObjectId

  orderId   String @db.ObjectId
  order     Order  @relation(fields: [orderId], references: [id])

  productId String @db.ObjectId
  title     String
  price     Int
  quantity  Int

  @@map("orderItems")
  @@index([orderId])
}

type Shipping {
  address Address
}

type Address {
  city          String
  country       String
  line1         String
  line2         String
  postal_code   String 
  state         String
}

model Cart {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  userId    String @db.ObjectId
  user      User   @relation(fields: [userId], references: [id])
  items     CartItem[]
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  @@map("carts")
  @@unique([userId])
}

model CartItem {
  id          String @id @default(auto()) @map("_id") @db.ObjectId

  cartId      String @db.ObjectId
  cart        Cart   @relation(fields: [cartId], references: [id])

  productId   String @map("product_id") @db.ObjectId
  product     Product @relation(fields: [productId], references: [id])

  quantity    Int

  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())

  @@map("cartItems")
  @@index([cartId])
  @@index([productId])
}

enum DeliveryStatus {
  NotProcessed
  Processing
  Dispatched
  Refunded
  Cancelled
  Delivered
}
