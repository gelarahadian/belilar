generator client {
  provider    = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider  = "mongodb"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model Account {
  id                 String  @id @default(auto()) @map("_id") @db.ObjectId
  userId             String  @map("user_id") @db.ObjectId
  type               String
  provider           String
  providerAccountId  String  @map("provider_account_id")
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?
 
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
 
  @@unique([provider, providerAccountId])
  @@map("accounts")
}
 
model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id") @db.ObjectId
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
 
  @@map("sessions")
}
 
model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  password      String? @map("password")
  image         String?
  role          String? @default(value: "user") 
  accounts      Account[]
  sessions      Session[]
  rating        Rating?
  order         Order[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now())
 
  @@map("users")
}
 
model VerificationToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String
  token      String
  expires    DateTime
 
  @@unique([identifier, token])
  @@map("verificationtokens")
}

model Tag {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  slug        String  @unique
  categoryId  String @map("category_id") @db.ObjectId
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  productIDs  String[] @map("product_ids") @db.ObjectId
  products    Product[] @relation(fields: [productIDs], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())

  @@map("tags")
}

model Category {
    id        String @id @default(auto()) @map("_id") @db.ObjectId
    name      String
    slug      String @unique
    tags      Tag[]
    products  Product[]
    createdAt DateTime @default(now())
    updatedAt DateTime @default(now())

    @@map("categories")
}

model Rating {
  id            String @id @default(auto()) @map("_id") @db.ObjectId
  rating        Int
  comment       String?

  postedBy      User @relation(fields: [postedById], references: [id]) 
  postedById    String @unique @db.ObjectId
  productId     String @map("product_id") @db.ObjectId
  product       Product @relation(fields: [productId], references: [id])
  
  @@map("ratings")
}

model Product {
    id              String @id @default(auto()) @map("_id") @db.ObjectId
    title           String @unique
    slug            String @unique
    description     String 
    price           Int
    previousPrice   Int
    images          Image[]
    color           String[]
    brand           String
    shipping        Int?
    likes           String[] 
    stock           Int?

    ratings         Rating[]
    cartItems       CartItem[]
    categoryId      String @map("category_id") @db.ObjectId
    category        Category @relation(fields: [categoryId], references: [id])
    tagIds          String[] @map("tag_ids") @db.ObjectId
    tags            Tag[] @relation(fields: [tagIds], references: [id])
    createdAt       DateTime @default(now())
    updatedAt       DateTime @default(now())

  @@map("products")
}

type Image {
  public_id    String 
  secure_url   String 

}

model Order {
  id                String @id @default(auto()) @map("_id") @db.ObjectId
  chargeId          String
  payment_intent    String
  receipt_url       String 
  refunded          Boolean
  status            String
  amount_captured   Int 
  currency          String
  shipping          Shipping
  userId            String @unique @map("user_id") @db.ObjectId
  user              User @relation(fields: [userId], references: [id])
  cartItemIds       String[] @map("cart_item_id") @db.ObjectId
  cartItems         CartItem[] @relation(fields: [cartItemIds], references: [id])
  refundId          String?
  deliveryStatus    DeliveryStatus @default(NotProcessed)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now())

  @@map("orders")
}

type Shipping {
  address Address
}

type Address {
  city          String
  country       String
  line1         String
  line2         String
  postal_code   String 
  state         String
}

model CartItem {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  productId   String @map("product_id") @unique @db.ObjectId
  product     Product @relation(fields: [productId], references: [id])
  title       String
  slug        String
  price       Int
  image       String
  quantity    Int
  orderIds    String[] @map("order_ids") @db.ObjectId
  orders      Order[] @relation(fields: [orderIds], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())

  @@map("cartItems")
}

enum DeliveryStatus {
  NotProcessed
  Processing
  Dispatched
  Refunded
  Cancelled
  Delivered
}
